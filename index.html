<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Komi widgets ‚Äî Translator & Assistant</title>
  <style>
    :root{
      --bg1:#e9f4ff;--bg2:#f7fbff;--card:#fff;--border:#dbe7f4;--ink:#0b1230;
      --muted:#6b7280;--accent:#16a34a;--accent2:#0ea5e9;--shadow:rgba(13,38,76,.12)
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:32px 18px;font-size:18px;line-height:1.45}
    .brand{font-size:34px;margin:0 0 16px;font-weight:900}
    .brand .v{font-size:12px;font-weight:700;padding:4px 10px;border-radius:999px;margin-left:8px;
      background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
    .tabs{display:flex;gap:.5rem;margin:.5rem 0 1.2rem;flex-wrap:wrap}
    .tab-btn{padding:.7rem 1.2rem;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .tab-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:none}
    .card{background:var(--card);border:1px solid var(--border);border-radius:22px;padding:26px;box-shadow:0 16px 40px var(--shadow)}
    .title{font-size:24px;font-weight:800;margin-bottom:10px}
    .row{display:flex;gap:.7rem;flex-wrap:wrap;align-items:center}
    .btn{padding:.75rem 1.1rem;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;transition:transform .12s ease}
    .btn:active{transform:scale(.98)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:none}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .txt{width:100%;padding:1rem;border-radius:14px;border:1px solid var(--border);font-size:18px}
    .out{min-height:70px;margin-top:12px;padding:14px;border-radius:14px;border:1px solid var(--border);background:#fff;font-size:20px}
    .badge{display:inline-block;padding:.25rem .65rem;border-radius:999px;background:#eef6ff;border:1px solid #d9e8f7;color:#194b7c;font-weight:900}
    .hidden{display:none}
    .meter{height:12px;background:#eef6ff;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin-top:8px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .35s ease}

    /* clickable examples */
    .examples{margin:2px 0 14px 0; display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .examples .label{font-size:14px;color:var(--muted);margin-right:6px;font-weight:900;letter-spacing:.2px}
    .ex-chip{
      padding:.35rem .7rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-size:14px;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .ex-chip:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(13,38,76,.08)}

    /* Games */
    .section{margin-top:18px}
    .section-title{display:flex;align-items:center;gap:10px;margin:0 0 10px 2px;flex-wrap:wrap}
    .section-title h2{margin:0;font-size:18px;font-weight:900}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:.25rem .65rem;border-radius:999px;background:#f3f8ff;border:1px solid var(--border);font-weight:900;font-size:13px;color:#194b7c}
    .games-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 900px){ .games-grid{grid-template-columns:1fr} }
    .panel{border:1px solid var(--border);border-radius:18px;padding:16px;background:#fff;position:relative;overflow:hidden}
    .panel h3{margin:0 0 6px 0;font-size:18px;font-weight:900}
    .mini{font-size:14px;color:var(--muted);margin:6px 0 12px 0}
    .big{font-size:22px;font-weight:950;letter-spacing:.2px}
    .cardface{border:1px dashed #c7d5e6;background:#f3f8ff;border-radius:16px;padding:14px}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .choice-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 520px){ .choice-grid{grid-template-columns:1fr} }
    .choice{width:100%;text-align:left}
    .choice.correct{border-color:#16a34a}
    .choice.wrong{border-color:#ef4444}
    .hintline{font-size:14px;color:var(--muted);margin-top:8px}

    /* animations */
    .pop{animation:pop .22s ease}
    @keyframes pop{0%{transform:scale(.98)}60%{transform:scale(1.02)}100%{transform:scale(1)}}
    .shake{animation:shake .28s ease}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}}
    .fadein{animation:fadein .35s ease}
    @keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    /* confetti */
    #confettiCanvas{position:fixed;inset:0;pointer-events:none;z-index:9999;display:none}

    /* Talk (offline) */
    .chat{border:1px solid var(--border);border-radius:16px;background:#f7fbff;padding:12px;max-height:220px;overflow:auto}
    .msg{padding:10px 12px;border-radius:14px;border:1px solid var(--border);background:#fff;margin:8px 0}
    .msg.me{background:#eef6ff}
    .msg .who{font-weight:900;font-size:13px;color:#194b7c;margin-bottom:4px}
    .chatrow{display:flex;gap:10px;align-items:center;margin-top:10px}
    .chatrow input{flex:1}
    .tiny{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<canvas id="confettiCanvas"></canvas>

<div class="wrap">
  <h1 class="brand">Komi widgets <span class="v">Translator & Assistant</span></h1>

  <div class="tabs">
    <button class="tab-btn active" data-tab="as">Assistant</button>
    <button class="tab-btn" data-tab="tr">Translator</button>
  </div>

  <!-- Assistant -->
  <div id="tab-as" class="card fadein">
    <div class="title">Assistant (Speak Komi)</div>
    <div class="examples" id="examples-as"></div>

    <input id="as-text" class="txt" placeholder="Type here‚Ä¶" />
    <div class="row" style="margin-top:.7rem">
      <button id="as-say" class="btn" disabled>Play Komi</button>
      <button id="as-record" class="btn primary" disabled>Record & Check</button>
      <span id="as-status" class="badge hidden"></span>
    </div>
    <div class="meter"><div id="as-bar" class="bar"></div></div>
  </div>

  <!-- Translator -->
  <div id="tab-tr" class="card hidden fadein">
    <div class="title">English to Komi Translator</div>
    <div class="examples" id="examples-tr"></div>

    <textarea id="src" class="txt" rows="4" placeholder="Type here‚Ä¶"></textarea>
    <div class="row" style="margin-top:.7rem">
      <button id="do" class="btn primary">Translate</button>
    </div>
    <div id="out" class="out"></div>
  </div>

  <!-- Games -->
  <div class="section">
    <div class="section-title">
      <h2>Games</h2>
      <span class="pill">Streak: <span id="streak">0</span></span>
      <span class="pill">Best: <span id="best">0</span></span>
    </div>

    <div class="games-grid">
      <!-- Game 1: Type Komi (NEW) -->
      <div class="panel">
        <h3>Game 1 ‚Äî Type Komi (Speed)</h3>
        <div class="mini">We show <b>English</b>. You type <b>Komi</b> and press <b>Check</b>.</div>

        <div class="cardface">
          <div class="mini">English</div>
          <div class="big" id="tk-en">Loading‚Ä¶</div>
          <div class="divider"></div>
          <div class="mini">Type Komi</div>
          <input id="tk-input" class="txt" style="margin-top:8px" placeholder="Type Komi here‚Ä¶" disabled />
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="tk-reveal" disabled>Reveal</button>
          <button class="btn primary" id="tk-check" disabled>Check</button>
          <button class="btn" id="tk-next" disabled>Next</button>
          <span class="pill">Score: <span id="tk-score">0</span></span>
          <span class="pill">‚è± <span id="tk-time">30</span>s</span>
        </div>

        <div class="hintline" id="tk-hint">Type fast to build streak. Confetti on correct ‚úÖ</div>
      </div>

      <!-- Game 2: Listen & Pick -->
      <div class="panel">
        <h3>Game 2 ‚Äî Listen & Pick</h3>
        <div class="mini">Click <b>Play Komi</b> and choose the meaning in English.</div>

        <div class="row" style="margin-bottom:10px">
          <button class="btn primary" id="lp-play" disabled>Play Komi</button>
          <button class="btn" id="lp-next" disabled>New round</button>
          <span class="pill">Correct: <span id="lp-correct">0</span></span>
        </div>

        <div class="mini" id="lp-status">Loading‚Ä¶</div>
        <div class="choice-grid" id="lp-choices"></div>

        <div class="hintline">If you get it right ‚Äî confetti üéâ</div>
      </div>
    </div>

    <!-- Extra WOW: Talk (offline mentor) -->
    <div class="panel" style="margin-top:14px">
      <h3>Bonus ‚Äî Talk (Offline Mentor)</h3>
      <div class="mini">Ask something simple like: <b>hello</b>, <b>how to say dog</b>, <b>give me a phrase</b>. (No internet.)</div>

      <div class="chat" id="chat"></div>
      <div class="chatrow">
        <input id="chat-in" class="txt" placeholder="Type message‚Ä¶" disabled />
        <button class="btn primary" id="chat-send" disabled>Send</button>
        <button class="btn" id="chat-voice" disabled>Voice</button>
      </div>
      <div class="tiny">Voice uses your browser‚Äôs built-in speech (still offline). If no voice available ‚Äî it will just show text.</div>
    </div>
  </div>
</div>

<script src="./widgets/mini-lm.js"></script>
<script>
  // Tabs switching
  const tabs={tr:document.getElementById('tab-tr'), as:document.getElementById('tab-as')};
  document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    tabs.tr.classList.toggle('hidden', b.dataset.tab!=='tr');
    tabs.as.classList.toggle('hidden', b.dataset.tab!=='as');
  }));

  const H=id=>document.getElementById(id);
  const norm = s => (s||'').toLowerCase().replace(/[.,!?;:()"‚Äú‚Äù']/g,' ').replace(/\s+/g,' ').trim();
  const toks = s => norm(s).split(' ').filter(Boolean);

  function mapLongest(tokens, dict, n=4){
    const out=[], unk=[]; let i=0;
    while(i<tokens.length){
      let hit=null,k=0;
      for(let m=Math.min(n,tokens.length-i); m>=1; m--){
        const p=tokens.slice(i,i+m).join(' ');
        if(dict[p]!==undefined){hit=dict[p];k=m;break;}
      }
      if(hit!==null){out.push(hit);i+=k;} else {out.push({__u:tokens[i]});unk.push(tokens[i]);i++;}
    } return {out,unk};
  }

  const dgs=[["sh","—à"],["ch","—á"],["zh","–∂"],["kh","—Ö"],["ts","—Ü"],["ya","—è"],["yu","—é"],["yo","–π–æ"],["ye","–µ"]];
  const cmap={"a":"–∞","b":"–±","c":"–∫","d":"–¥","e":"–µ","f":"—Ñ","g":"–≥","h":"—Ö","i":"–∏","j":"–¥–∂","k":"–∫","l":"–ª","m":"–º","n":"–Ω","o":"–æ","p":"–ø","q":"–∫","r":"—Ä","s":"—Å","t":"—Ç","u":"—É","v":"–≤","w":"–≤","x":"–∫—Å","y":"—ã","z":"–∑","-":"-","'":"‚Äô"," ":" "};
  function translit(en){ let s=en.toLowerCase(); for(const [a,b] of dgs){ s=s.replaceAll(a,b);} let o=""; for(const ch of s){ o+=cmap[ch]??ch;} return o; }
  function finalize(ch){ const p=[]; for(const c of ch){ if(typeof c==='string') p.push(c); else if(c&&c.__u) p.push(translit(c.__u)); } return p.join(' ').replace(/\s+/g,' ').trim(); }

  let DICT=null;

  // Assistant: score only
  const statusEl = H('as-status');
  const setScore = v=> H('as-bar').style.width = Math.max(0, Math.min(100, v)) + '%';
  const hideStatus = ()=>{ statusEl.classList.add('hidden'); statusEl.textContent=''; };
  const showScore  = (s)=>{ statusEl.textContent = 'Score: ' + s + ' / 100'; statusEl.classList.remove('hidden'); statusEl.classList.add('pop'); setTimeout(()=>statusEl.classList.remove('pop'), 250); };

  // Words we use everywhere (simple & clear)
  const START_WORDS = [
    "Good morning",
    "Hello",
    "Good day",
    "Komi man",
    "Komi woman",
    "Child",
    "Forest",
    "Fish",
    "River",
    "Rain",
    "Dog",
    "Cat",
    "I love you"
  ];

  function renderExamples(containerId, inputId){
    const box = document.getElementById(containerId);
    if(!box) return;

    box.innerHTML =
      `<span class="label">TRY THESE WORDS:</span>` +
      START_WORDS.map(t =>
        `<button type="button" class="ex-chip" data-fill="${t.replace(/"/g,'&quot;')}">${t}</button>`
      ).join("");

    box.querySelectorAll(".ex-chip").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const v = btn.getAttribute("data-fill") || "";
        const input = document.getElementById(inputId);
        if(input){
          input.value = v;
          input.focus();
        }
      });
    });
  }
  renderExamples("examples-tr", "src");
  renderExamples("examples-as", "as-text");

  // Speech + scoring
  function toKomi(text){
    const {out} = mapLongest(toks(text), DICT||{}, 4);
    return finalize(out);
  }
  function speakKomi(text){
    const u=new SpeechSynthesisUtterance(text);
    u.lang='ru-RU'; u.rate=0.95;
    const pick = speechSynthesis.getVoices().find(v=>/ru/i.test(v.lang)) || null;
    if(pick) u.voice=pick;
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
  function normForASR(s){
    return String(s||'')
      .toLowerCase()
      .replace(/—ë/g,'–µ').replace(/”ß/g,'–æ').replace(/–π/g,'–∏')
      .replace(/[‚Äô'`]/g,'')
      .replace(/[^a-z–∞-—è\- ]/g,'')
      .replace(/\s+/g,' ')
      .trim();
  }
  function levenshtein(a,b){
    const m=[]; for(let i=0;i<=a.length;i++) m[i]=[i];
    for(let j=1;j<=b.length;j++) m[0][j]=j;
    for(let i=1;i<=a.length;i++){
      for(let j=1;j<=b.length;j++){
        m[i][j]=Math.min(m[i-1][j]+1, m[i][j-1]+1, m[i-1][j-1]+(a[i-1]===b[j-1]?0:1));
      }
    }
    return m[a.length][b.length];
  }
  function scoreRef(rec, ref){
    const heard = normForASR(rec);
    const target = normForASR(ref);
    const dRaw = levenshtein(heard, target);
    const forgiveness = Math.floor(target.length / 6);
    const dEff = Math.max(0, dRaw - forgiveness);
    const base = Math.max(0, Math.min(100, Math.round(100 * (1 - dEff / Math.max(1, target.length)))));

    let final = base;
    try{
      if (window.MiniLM && window.MiniLM.ready && typeof window.MiniLM.score === 'function'){
        const ml = Math.max(0, Math.min(100, Number(window.MiniLM.score(heard, target)) || 0));
        final = Math.round(0.6 * base + 0.4 * ml);
      }
    }catch(_){}
    return Math.max(0, Math.min(100, final + 5));
  }

  // Translator
  function translate(){
    if(!DICT) return;
    const {out} = mapLongest(toks(H('src').value), DICT, 4);
    H('out').textContent = finalize(out);
    H('out').classList.add('pop'); setTimeout(()=>H('out').classList.remove('pop'), 250);
  }
  H('do').addEventListener('click', translate);
  H('src').addEventListener('keydown', e => { if(e.key==='Enter' && (e.ctrlKey||e.metaKey)) translate(); });

  // Assistant actions
  H('as-say').addEventListener('click', ()=>{
    const en=(H('as-text').value||'').trim();
    if(!en) return;
    hideStatus();
    speakKomi(toKomi(en));
  });
  H('as-record').addEventListener('click', ()=>{
    const en=(H('as-text').value||'').trim();
    if(!en) return;

    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR) return;

    const target = toKomi(en);
    const rec=new SR(); rec.lang='ru-RU'; rec.interimResults=false; rec.maxAlternatives=1;

    hideStatus();
    setScore(0);

    rec.onresult=(e)=>{
      const heard=e.results[0][0].transcript||'';
      const s=scoreRef(heard,target);
      setScore(s);
      showScore(s);
      if (s >= 85) confettiBurst();
    };
    rec.start();
  });

  // -------------------------
  // GAMES (use ONLY our known words)
  // -------------------------
  let GAME_POOL = []; // [{en, komi}]
  function buildGamePool(){
    const out = [];
    for (const en of START_WORDS){
      const komi = toKomi(en);
      if (komi && komi.trim()) out.push({en, komi});
    }
    return out;
  }

  function initStats(){
    const streak = Number(localStorage.getItem('komi_streak')||'0')||0;
    const best   = Number(localStorage.getItem('komi_best')||'0')||0;
    H('streak').textContent = String(streak);
    H('best').textContent   = String(best);
  }
  function todayKey(){
    const d = new Date();
    return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
  }
  function bumpStreak(){
    const last = localStorage.getItem('komi_last_day') || '';
    const t = todayKey();
    if (last !== t){
      const cur = Number(localStorage.getItem('komi_streak')||'0')||0;
      localStorage.setItem('komi_streak', String(cur+1));
      localStorage.setItem('komi_last_day', t);
      H('streak').textContent = String(cur+1);
    }
  }
  function updateBest(v){
    const best = Number(localStorage.getItem('komi_best')||'0')||0;
    if (v > best){
      localStorage.setItem('komi_best', String(v));
      H('best').textContent = String(v);
    }
  }
  function randItem(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function shuffle(a){
    const arr = a.slice();
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  // Game 1: Type Komi (Speed) ‚Äî NEW
  let tk = { current:null, score:0, time:30, timer:null, locked:false };
  function initTypeKomi(){
    H('tk-reveal').disabled = false;
    H('tk-check').disabled = false;
    H('tk-next').disabled = false;
    H('tk-input').disabled = false;

    tk.score = 0;
    H('tk-score').textContent = '0';
    resetTimer();
    nextTypeKomi();

    H('tk-next').onclick = ()=>{ nextTypeKomi(); };
    H('tk-reveal').onclick = ()=>{
      if(!tk.current) return;
      H('tk-hint').textContent = 'Answer: ' + tk.current.komi;
      H('tk-hint').classList.add('pop'); setTimeout(()=>H('tk-hint').classList.remove('pop'), 250);
    };
    H('tk-check').onclick = ()=> checkTypeKomi();
    H('tk-input').addEventListener('keydown', (e)=>{
      if(e.key==='Enter') checkTypeKomi();
    });
  }
  function resetTimer(){
    tk.time = 30;
    H('tk-time').textContent = String(tk.time);
    if(tk.timer) clearInterval(tk.timer);
    tk.timer = setInterval(()=>{
      tk.time -= 1;
      H('tk-time').textContent = String(Math.max(0, tk.time));
      if(tk.time <= 0){
        clearInterval(tk.timer);
        tk.timer = null;
        tk.locked = true;
        H('tk-hint').textContent = 'Time! Press Next.';
        H('tk-hint').classList.add('shake'); setTimeout(()=>H('tk-hint').classList.remove('shake'), 300);
      }
    }, 1000);
  }
  function nextTypeKomi(){
    tk.locked = false;
    H('tk-hint').textContent = 'Type fast to build streak. Confetti on correct ‚úÖ';
    H('tk-input').value = '';
    H('tk-input').focus();
    tk.current = randItem(GAME_POOL);
    H('tk-en').textContent = tk.current.en;
    H('tk-en').classList.add('pop'); setTimeout(()=>H('tk-en').classList.remove('pop'), 250);
    resetTimer();
  }
  function normalizeKomiLite(s){
    return String(s||'')
      .toLowerCase()
      .replace(/—ë/g,'–µ').replace(/”ß/g,'–æ')
      .replace(/[‚Äô'`]/g,'')
      .replace(/\s+/g,' ')
      .trim();
  }
  function checkTypeKomi(){
    if(tk.locked) return;
    if(!tk.current) return;

    const guess = normalizeKomiLite(H('tk-input').value);
    const ans   = normalizeKomiLite(tk.current.komi);

    if(!guess){
      H('tk-hint').textContent = 'Type something first üôÇ';
      H('tk-hint').classList.add('shake'); setTimeout(()=>H('tk-hint').classList.remove('shake'), 300);
      return;
    }

    if(guess === ans){
      tk.score += 1;
      H('tk-score').textContent = String(tk.score);
      updateBest(tk.score);
      bumpStreak();
      confettiBurst();
      H('tk-hint').textContent = 'Correct ‚úÖ  Press Next!';
      H('tk-hint').classList.add('pop'); setTimeout(()=>H('tk-hint').classList.remove('pop'), 250);
      tk.locked = true;
      if(tk.timer) { clearInterval(tk.timer); tk.timer=null; }
    } else {
      H('tk-hint').textContent = 'Not quite ‚ùå  Try again or press Reveal.';
      const panel = H('tk-hint');
      panel.classList.add('shake'); setTimeout(()=>panel.classList.remove('shake'), 300);
    }
  }

  // Game 2: Listen & Pick (only these words)
  let lp = { current:null, choices:[], locked:false, correct:0 };
  function initListenPick(){
    H('lp-play').disabled = false;
    H('lp-next').disabled = false;
    H('lp-status').textContent = 'Click Play Komi, then choose:';

    lp.correct = 0;
    H('lp-correct').textContent = '0';
    newRound();

    H('lp-play').onclick = ()=>{
      if (!lp.current) return;
      speakKomi(lp.current.komi);
    };
    H('lp-next').onclick = ()=> newRound();
  }
  function newRound(){
    lp.locked = false;
    lp.current = randItem(GAME_POOL);

    const distract = shuffle(GAME_POOL.filter(x=>x.en!==lp.current.en)).slice(0,3);
    lp.choices = shuffle([lp.current, ...distract]).map(x=>x.en);

    H('lp-status').textContent = 'Click Play Komi, then choose:';
    renderChoices();
  }
  function renderChoices(){
    const box = H('lp-choices');
    box.innerHTML = '';
    lp.choices.forEach(en=>{
      const b = document.createElement('button');
      b.className = 'btn choice';
      b.type = 'button';
      b.textContent = en;
      b.onclick = ()=> handleChoice(en);
      box.appendChild(b);
    });
  }
  function handleChoice(en){
    if (lp.locked) return;
    lp.locked = true;

    const correctEn = lp.current.en;
    const buttons = [...H('lp-choices').querySelectorAll('button')];
    buttons.forEach(b=>{
      if (b.textContent === correctEn) b.classList.add('correct');
      else if (b.textContent === en) b.classList.add('wrong');
      b.disabled = true;
    });

    if (en === correctEn){
      lp.correct += 1;
      H('lp-correct').textContent = String(lp.correct);
      updateBest(lp.correct);
      bumpStreak();
      H('lp-status').textContent = 'Correct ‚úÖ  (press New round)';
      H('lp-status').classList.add('pop'); setTimeout(()=>H('lp-status').classList.remove('pop'), 250);
      confettiBurst();
    } else {
      H('lp-status').textContent = 'Wrong ‚ùå  (press New round)';
      H('lp-status').classList.add('shake'); setTimeout(()=>H('lp-status').classList.remove('shake'), 300);
    }
  }

  // -------------------------
  // BONUS: Offline Mentor (simple rule-based + voice)
  // -------------------------
  const chat = H('chat');
  let voiceOn = true;
  function addMsg(who, text){
    const d = document.createElement('div');
    d.className = 'msg ' + (who==='You' ? 'me' : 'bot');
    d.innerHTML = `<div class="who">${who}</div><div>${escapeHtml(text)}</div>`;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
    d.classList.add('fadein');
  }
  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
  }
  function mentorReply(userText){
    const t = norm(userText);

    // quick intents
    if(!t) return "Type something üôÇ Try: hello, how to say dog, give me a phrase.";

    if(t.includes('hello')) return `Try: "Hello" ‚Üí Komi: "${toKomi('Hello')}".`;
    if(t.includes('good day')) return `Try: "Good day" ‚Üí Komi: "${toKomi('Good day')}".`;
    if(t.includes('dog')) return `Dog ‚Üí Komi: "${toKomi('Dog')}".`;
    if(t.includes('cat')) return `Cat ‚Üí Komi: "${toKomi('Cat')}".`;
    if(t.includes('fish')) return `Fish ‚Üí Komi: "${toKomi('Fish')}".`;
    if(t.includes('river')) return `River ‚Üí Komi: "${toKomi('River')}".`;
    if(t.includes('forest')) return `Forest ‚Üí Komi: "${toKomi('Forest')}".`;
    if(t.includes('i love you') || (t.includes('love') && t.includes('you'))) return `"I love you" ‚Üí Komi: "${toKomi('I love you')}".`;

    if(t.includes('phrase') || t.includes('give me')){
      const pick = randItem(START_WORDS);
      return `Try this: "${pick}" ‚Üí Komi: "${toKomi(pick)}".`;
    }

    if(t.includes('how to say') || t.startsWith('say ')){
      // naive extraction
      const q = t.replace('how to say','').replace('say','').trim();
      if(!q) return 'Tell me the word üôÇ Example: "how to say dog"';
      // best effort: Title-case first letter
      const english = q.split(' ').map(x=>x.charAt(0).toUpperCase()+x.slice(1)).join(' ');
      return `"${english}" ‚Üí Komi: "${toKomi(english)}".`;
    }

    return `Try these: Hello, Good day, Dog, Cat, Fish. Or type: "how to say river".`;
  }
  function speak(text){
    if(!voiceOn) return;
    try{
      const u=new SpeechSynthesisUtterance(text);
      u.lang='ru-RU'; u.rate=1.0;
      const pick = speechSynthesis.getVoices().find(v=>/ru/i.test(v.lang)) || null;
      if(pick) u.voice=pick;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }catch(_){}
  }
  function initMentor(){
    H('chat-in').disabled = false;
    H('chat-send').disabled = false;
    H('chat-voice').disabled = false;

    addMsg('Mentor', 'Hi! I am an offline helper. Try: "hello", "how to say dog", "give me a phrase".');

    H('chat-voice').textContent = 'Voice: ON';
    H('chat-voice').onclick = ()=>{
      voiceOn = !voiceOn;
      H('chat-voice').textContent = voiceOn ? 'Voice: ON' : 'Voice: OFF';
    };

    function send(){
      const v = (H('chat-in').value||'').trim();
      if(!v) return;
      H('chat-in').value = '';
      addMsg('You', v);
      const r = mentorReply(v);
      addMsg('Mentor', r);
      speak(r);
    }
    H('chat-send').onclick = send;
    H('chat-in').addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
  }

  // -------------------------
  // CONFETTI (keep)
  // -------------------------
  const C = H('confettiCanvas');
  const ctx = C.getContext('2d');
  let confettiTimer = null;

  function resizeConfetti(){
    C.width = window.innerWidth;
    C.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeConfetti);
  resizeConfetti();

  function confettiBurst(){
    if (!ctx) return;
    C.style.display = 'block';

    const N = 160;
    const parts = Array.from({length:N}, ()=>({
      x: Math.random()*C.width,
      y: -20 - Math.random()*200,
      vx: (Math.random()-0.5)*7,
      vy: 2 + Math.random()*7,
      r: 2 + Math.random()*5,
      a: Math.random()*Math.PI*2,
      va: (Math.random()-0.5)*0.35
    }));

    const start = performance.now();
    const dur = 1200;

    function frame(t){
      const dt = (t-start);
      ctx.clearRect(0,0,C.width,C.height);

      parts.forEach(p=>{
        p.x += p.vx;
        p.y += p.vy;
        p.a += p.va;
        p.vy += 0.02;

        const hue = (p.x / C.width) * 360;
        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.a);
        ctx.fillStyle = `hsl(${hue},90%,55%)`;
        ctx.fillRect(-p.r, -p.r, p.r*2.3, p.r*1.7);
        ctx.restore();
      });

      if (dt < dur){
        confettiTimer = requestAnimationFrame(frame);
      } else {
        ctx.clearRect(0,0,C.width,C.height);
        C.style.display = 'none';
      }
    }

    if (confettiTimer) cancelAnimationFrame(confettiTimer);
    confettiTimer = requestAnimationFrame(frame);
  }

  // Load dictionary
  async function loadAll(){
    const bust = 'v=' + Date.now();
    try{
      const base = await fetch(`./data/dictionary.json?${bust}`,{cache:'no-store'}).then(r=>r.json());
      let dict = {...base};

      const manifest = await fetch(`./data/overlays/overlay_manifest.json?${bust}`,{cache:'no-store'}).then(r=>r.json());
      if(!Array.isArray(manifest)) throw new Error('overlay_manifest.json must be an array of filenames');

      for (const file of manifest) {
        try{
          const ov = await fetch(`./data/overlays/${file}?${bust}`, {cache:'no-store'}).then(r=>r.json());
          dict = { ...dict, ...ov };
        }catch(e){
          console.warn('[dict] overlay NOT loaded:', file, e);
        }
      }

      DICT = dict;
      if (window.MiniLM && typeof window.MiniLM.init === 'function') window.MiniLM.init(DICT);

      H('as-say').disabled = false;
      H('as-record').disabled = false;

      // games pool only from our known words
      GAME_POOL = buildGamePool();
      initStats();
      initTypeKomi();
      initListenPick();

      // mentor
      initMentor();
    }catch(e){
      console.error(e);
      H('as-say').disabled = true;
      H('as-record').disabled = true;
      H('tk-en').textContent = 'Load error';
      H('lp-status').textContent = 'Load error';
      addMsg('Mentor','Load error ‚Äî open console.');
    }
  }

  loadAll();
</script>
</body>
</html>



